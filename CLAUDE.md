# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## System Overview

This is a Django-based Educational Institution Clearance System for managing student clearances, enrollment forms, and graduation forms. The system supports multiple user types (students, alumni, signatories, registrars) with role-based approval workflows.

## Development Commands

### Running the Server
```bash
python manage.py runserver
```

## Production Cron Setup

### Automated Task Schedule (Philippines Time)
The system uses Linux cron for scheduled tasks instead of Celery for easier deployment:

**Scheduled Tasks:**
- **Monday 6:00 AM:** Weekly reports generation
- **Daily 6:00 PM:** Daily digest emails  
- **Sunday 2:00 AM:** Cleanup old report packs

### Production Server Setup Steps

1. **Upload your Django project to server**
2. **Set server timezone to Philippines:**
   ```bash
   sudo timedatectl set-timezone Asia/Manila
   ```

3. **Add cron jobs (run on server):**
   ```bash
   crontab -e
   ```
   
4. **Add these lines to crontab:**
   ```bash
   # Weekly reports every Monday at 6:00 AM Philippines time
   0 6 * * 1 cd /path/to/your/mysite && python manage.py generate_weekly_reports >> /var/log/django_cron.log 2>&1
   
   # Daily digest every day at 6:00 PM Philippines time  
   0 18 * * * cd /path/to/your/mysite && python manage.py send_daily_digest >> /var/log/django_cron.log 2>&1
   
   # Cleanup old reports every Sunday at 2:00 AM Philippines time
   0 2 * * 0 cd /path/to/your/mysite && python manage.py cleanup_old_reports --retention-weeks=4 >> /var/log/django_cron.log 2>&1
   ```

5. **Replace `/path/to/your/mysite` with your actual project path**

6. **Verify cron jobs are scheduled:**
   ```bash
   crontab -l
   ```

7. **Monitor logs:**
   ```bash
   tail -f /var/log/django_cron.log
   ```

### Cron Format Explanation
```
* * * * *
│ │ │ │ │
│ │ │ │ └── Day of week (0=Sunday, 1=Monday, ..., 6=Saturday)
│ │ │ └──── Month (1-12)
│ │ └────── Day of month (1-31)  
│ └──────── Hour (0-23)
└────────── Minute (0-59)
```

### Database Operations
```bash
python manage.py migrate          # Apply database migrations  
python manage.py makemigrations   # Create new migrations
python manage.py collectstatic    # Collect static files
```

### System Management Commands
```bash
# Clean up duplicate/orphaned records
python manage.py cleanup_signatory_records

# Test system integrity
python manage.py test_system_fixes

# Fix clearance-signatory system issues
python manage.py fix_clearance_signatory_system

# Generate weekly reports
python manage.py generate_weekly_reports

# Test auto-report generation
python manage.py test_auto_reports
```

### User Management Commands
```bash
# Create test data
python manage.py create_test_clearance
python manage.py create_test_signatory
python manage.py create_all_signatories

# Fix profile issues
python manage.py fix_profile_pictures
python manage.py fix_admin_profile
```

## Architecture Overview

### Core Applications
- **mysite/**: Main Django project with settings, URLs, and primary views
- **landing/**: Main application containing models, views, and business logic

### User Types & Roles
- **Students**: Submit clearance, enrollment, and graduation forms
- **Alumni**: Similar to students but with alumni-specific profiles  
- **Signatories**: 10 different types who approve/disapprove forms:
  - Dorm Supervisor, Canteen Concessionaire, Library Director
  - Scholarship Director, IT Director, Student Affairs
  - Cashier, Business Manager, Registrar, Academic Dean
- **Registrars**: Administrative users managing document release and user management

### Multi-Signatory Approval System
The system requires ALL 10 signatory types to approve a clearance for it to be complete:
- Each signatory type operates independently
- Individual approval/disapproval tracking per signatory
- Form status only becomes "approved" when all signatories approve
- Comprehensive audit trails and activity logs

### Key Models
- **User**: Custom user model with UUID primary keys
- **ClearanceForm**: Core clearance tracking with signatory status methods
- **ClearanceSignatory**: Individual signatory approval records
- **EnrollmentForm/GraduationForm**: Specialized form types
- **SignatoryProfile**: Signatory-specific data and PIN security
- **AutoGeneratedReport**: Automated report generation system

### Database Configuration
- Uses MySQL database (`pts_rc`)
- UUID primary keys throughout for security
- Comprehensive indexing for performance
- JSON fields for flexible data storage (subjects, form data)

## File Structure

### Backend
- `mysite/settings.py`: Django configuration with MySQL setup
- `mysite/views.py`: All view logic (single large file ~4000+ lines)
- `landing/models.py`: All model definitions
- `landing/management/commands/`: Custom Django management commands

### Frontend
- `templates/`: HTML templates for all pages
- `static/css/`: Stylesheets for different user roles (RCLEARANCE.css, SCLEARANCE.css, etc.)
- `static/js/`: JavaScript for each page (RDASHBOARD.js, SDASHBOARD.js, etc.)
- `media/`: File uploads (profile pictures, reports)

### Key Features
- **Dashboard Systems**: Separate dashboards for each user type
- **Report Generation**: Manual and automated report generation with HTML output
- **PIN Security**: Signatories use PINs for secure approvals
- **Bulk Operations**: Bulk approve/disapprove/delete functionality
- **Audit Logging**: Comprehensive activity tracking
- **Calendar Integration**: Event management for institutions

## Important Technical Notes

### Database Integrity
The system has experienced and resolved issues with:
- Duplicate signatory records
- Orphaned clearance data  
- Inconsistent approval states
- Role mapping problems

Always run `python manage.py test_system_fixes` before major changes.

### Security Considerations
- Uses hashed PINs for signatory authentication
- IP address tracking for all approvals
- Custom user model with UUID primary keys
- Profile picture upload validation

### Performance Considerations  
- Large single views file may need refactoring
- Complex signatory status queries should use provided model methods
- Static file serving configured for development
- Database indexes on critical lookup fields

## Recent System Fixes

A comprehensive system fix was implemented addressing:
- Multi-signatory approval workflow issues
- Duplicate database records cleanup
- Individual signatory status tracking
- Dashboard loading and modal display problems

Refer to `COMPREHENSIVE_SYSTEM_FIXES.md` for detailed information about recent fixes and system workflow.

## Coding Style Guide for Claude Code

### Python (Django)
- Use **snake_case** for variables and functions.
- Use **PascalCase** for class names.
- Keep imports grouped: standard library, third-party, local.
- Keep views modular — avoid adding to the large `views.py` unless necessary; create new files when possible.
- Use Django model methods for queries instead of raw SQL unless unavoidable.

### HTML / Templates
- Use Bootstrap 5 for layout and components.
- Keep templates in `templates/` with clear naming by role/module.
- Avoid inline CSS — use files in `static/css/`.
- Use `{% block %}` and `{% extends %}` to reuse layouts.
- Ensure mobile responsiveness.

### JavaScript
- Use **camelCase** for variables and functions.
- Keep scripts in `static/js/` with file names matching their page/module.
- Avoid inline JS in templates — link to JS files instead.
- Use event listeners instead of inline `onclick` attributes.
- Keep code modular and reusable.

### CSS
- Use class selectors over IDs unless IDs are needed for JavaScript hooks.
- Organize by section/component.
- Keep separate role-based CSS files (`RCLEARANCE.css`, etc.).

---

## Special Instructions for Claude Code
- Always follow Django best practices for file placement and code structure.
- Keep feature changes modular and avoid breaking unrelated workflows.
- **Never modify code that is not directly relevant to the current feature or task being developed.**
- You may suggest and implement additional features or design improvements if they will make the system better, but always explain these changes before applying them.
- For any new feature:
  1. Add/update backend views, models, and URLs.
  2. Create/update templates and static assets.
  3. Test in both Chrome and Firefox.
- Ensure mobile responsiveness for all UI changes.
- Ask before refactoring large files — especially `views.py`.




