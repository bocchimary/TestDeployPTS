{% extends 'main-registrar.html' %}
{% load static %}

{% block title %}REGISTRAR GRADUATION{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/RGRADUATION.css' %}?v=1.1">
<style>
/* Preview & Print Modal Styles - minimal to avoid interference */
.preview-print-content {
  background: white;
  padding: 20px;
  overflow-y: auto;
  max-height: 70vh;
}

/* Modal preview only - preserve original template designs */
</style>
{% endblock %}

{% block main_content %}
  
  <div class="registrar_graduation_main-content">
    <script>
      // Mark the graduation link as active
      document.addEventListener('DOMContentLoaded', function() {
        const graduationLink = document.querySelector('a[href="{% url "registrar_graduation" %}"]');
        if (graduationLink) {
          graduationLink.classList.add('active');
        }
      });
    </script>
    <form id="registrar_graduation_form">
      <div class="text-end text-muted mb-2 small"><strong>Date:</strong> <span id="registrar_graduation_dateToday"></span></div>
      <h1 class="fw-bold">List of Graduation Forms</h1>

      <!-- Filter + Search Row -->
      <div class="row mb-3">
        <div class="col-12">
          <!-- Filters Row -->
          <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
            <div class="filter-group">
              <select class="form-select form-select-sm" style="min-width: 180px;" id="registrar_graduation_filter_course">
                <option selected disabled>Filter by Course</option>
              </select>
            </div>
            <div class="filter-group">
              <select class="form-select form-select-sm" style="min-width: 150px;" id="registrar_graduation_filter_year">
                <option selected disabled>Filter by Year</option>
              </select>
            </div>
            <div class="filter-group">
              <select class="form-select form-select-sm" style="min-width: 160px;" id="registrar_graduation_filter_section">
                <option selected disabled>Filter by Section</option>
              </select>
            </div>
            <div class="filter-group">
              <select class="form-select form-select-sm" style="min-width: 160px;" id="registrar_graduation_filter_status">
                <option selected disabled>Filter by Status</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="filter-group">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="registrar_graduation_reset_filters">
                <i class="bi bi-arrow-clockwise me-1"></i>Reset Filters
              </button>
            </div>
          </div>
          
          <!-- Search Row -->
          <div class="d-flex align-items-center">
            <div class="registrar_graduation_search-bar input-group" style="max-width: 400px;">
              <input type="text" class="form-control" placeholder="Search by name or ID number..." id="registrar_graduation_search_input">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Actions Section -->
      <div class="row mb-3" id="registrar_graduation_bulk_actions" style="display: none;">
        <div class="col-12">
          <div class="d-flex gap-2 align-items-center">
            <span class="text-muted small" id="registrar_graduation_selected_count">0 selected</span>
            <button type="button" class="btn btn-primary btn-sm" onclick="bulkApproveGraduation()">
              <i class="bi bi-check-circle me-1"></i>Bulk Approve
            </button>
            <button type="button" class="btn btn-warning btn-sm" onclick="bulkDisapproveGraduation()">
              <i class="bi bi-x-circle me-1"></i>Bulk Disapprove
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="bulkPrintGraduation()">
              <i class="bi bi-printer me-1"></i>Bulk Print
            </button>
            <button type="button" class="btn btn-danger btn-sm graduation-bulk-delete-btn">
              <i class="bi bi-trash me-1"></i>Bulk Delete
            </button>
          </div>
        </div>
      </div>

      <div class="registrar_graduation_table-fixed-container">
        <div class="registrar_graduation_table-scroll-wrapper">
          <table class="table registrar_graduation_table text-center align-middle">
            <thead class="table-dark">
              <tr>
                <th style="width: 50px; min-width: 50px;">
                  <input type="checkbox" id="registrar_graduation_select_all" title="Select All">
                </th>
                <th style="width: 200px; min-width: 200px;">Student Name</th>
                <th style="width: 120px; min-width: 120px;">Course</th>
                <th style="width: 80px; min-width: 80px;">Year</th>
                <th style="width: 100px; min-width: 100px;">Section</th>
                <th style="width: 120px; min-width: 120px;">ID Number</th>
                <th style="width: 130px; min-width: 130px;">Application No.</th>
                <th style="width: 140px; min-width: 140px;">Date Submitted</th>
                <th style="width: 140px; min-width: 140px;">PDF File</th>
                <th style="width: 140px; min-width: 140px;">Academic Dean</th>
                <th style="width: 140px; min-width: 140px;">Business Manager</th>
                <th style="width: 140px; min-width: 140px;">Registrar</th>
                <th style="width: 140px; min-width: 140px;">President</th>
                <th style="width: 120px; min-width: 120px;">Status</th>
                <th style="width: 100px; min-width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody id="registrar_graduation_table_body">
              <!-- Dynamic content will be loaded here by JavaScript -->
              <tr>
                <td colspan="16" class="text-center text-muted py-4">
                  <i class="bi bi-hourglass-split fs-1"></i><br>
                  Loading graduation data...
                </td>
              </tr>
            </tbody>
          </table>

          <!-- OTP SIDEBAR -->
          <div id="registrar_graduation_otpSidebar" class="registrar_graduation_otp-sidebar">
            <div class="registrar_graduation_otp-header d-flex justify-content-between align-items-start">
              <h4 class="mb-0 fw-bold" id="registrar_graduation_approve_title">APPROVAL PIN</h4>
              <button type="button" class="btn-close graduation-close-otp-btn" aria-label="Close"></button>
            </div>
            <div class="registrar_graduation_otp-body d-flex flex-column align-items-center justify-content-center text-center">
              <p class="text-muted mb-3 w-100 text-start">Input Pincode to Proceed:</p>
              <div class="d-flex justify-content-center gap-2 mb-3">
                <input type="text" class="form-control text-center" maxlength="8" placeholder="Enter PIN" id="registrar_graduation_otpinput">
              </div>
              <div class="mb-3 w-100">
                <label for="registrar_graduation_otpComment" class="form-label text-muted">Comment (optional):</label>
                <textarea class="form-control" rows="2" id="registrar_graduation_otpComment" placeholder="Add a comment..."></textarea>
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-dark registrar_graduation_approve-btn" id="registrar_graduation_verifyOtpBtn">APPROVE</button>
              </div>
              <div class="text-danger mt-2" id="registrar_graduation_otpError" style="display: none;">Incorrect PIN</div>
            </div>
          </div>

          <!-- DISAPPROVE SIDEBAR -->
          <div id="registrar_graduation_disapproveSidebar" class="registrar_graduation_otp-sidebar">
            <div class="registrar_graduation_otp-header d-flex justify-content-between align-items-start">
              <h4 class="mb-0 fw-bold" id="registrar_graduation_disapprove_title">DISAPPROVE REASON</h4>
              <button type="button" class="btn-close graduation-close-disapprove-btn" aria-label="Close"></button>
            </div>
          
            <!-- WRAPPER for body steps -->
            <div class="registrar_graduation_otp-body">
          
              <!-- STEP 1: PIN -->
              <div id="registrar_graduation_disapprove_pin_step">
                <p class="text-muted mb-3 w-100 text-start">Input Pincode to Proceed:</p>
                <div class="d-flex justify-content-center gap-2 mb-3">
                  <input type="text" class="form-control text-center" maxlength="8" placeholder="Enter PIN" id="registrar_graduation_disapprove_pin_input">
                </div>
                <div class="text-center mb-2">
                  <button type="button" class="btn btn-dark" id="registrar_graduation_disapprove_pin_submit_btn">VERIFY</button>
                </div>
                <div class="text-danger mt-2" id="registrar_graduation_disapprove_pin_error" style="display: none;">Incorrect PIN</div>
              </div>
          
              <!-- STEP 2: Reason (Initially hidden) -->
              <div id="registrar_graduation_disapprove_reason_step" style="display: none;">
                <p class="text-muted mb-3 w-100 text-start">Please select a reason:</p>
          
                <!-- REASONS -->
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Unpaid fees" id="registrar_graduation_reason1">
                  <label class="form-check-label" for="registrar_graduation_reason1">Unpaid fees</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Damage to school property" id="registrar_graduation_reason2">
                  <label class="form-check-label" for="registrar_graduation_reason2">Damage to school property</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Violation of rules" id="registrar_graduation_reason3">
                  <label class="form-check-label" for="registrar_graduation_reason3">Violation of rules</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Unreturned school property" id="registrar_graduation_reason4">
                  <label class="form-check-label" for="registrar_graduation_reason4">Unreturned school property</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Incomplete Requirements/Documents" id="registrar_graduation_reason5">
                  <label class="form-check-label" for="registrar_graduation_reason5">Incomplete Requirements/Documents</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Incomplete course requirements" id="registrar_graduation_reason6">
                  <label class="form-check-label" for="registrar_graduation_reason6">Incomplete course requirements</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Unsettled promissory note" id="registrar_graduation_reason7">
                  <label class="form-check-label" for="registrar_graduation_reason7">Unsettled promissory note</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Incomplete academic units" id="registrar_graduation_reason8">
                  <label class="form-check-label" for="registrar_graduation_reason8">Incomplete academic units</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input graduation-reason-other" type="checkbox" value="Other" id="registrar_graduation_reasonOther">
                  <label class="form-check-label" for="registrar_graduation_reasonOther">Other</label>
                </div>
          
                <div class="mb-2" id="registrar_graduation_otherReasonContainer" style="display: none;">
                  <input type="text" id="registrar_graduation_otherReasonInput" class="form-control" placeholder="Enter other reason">
                </div>
          
                <!-- Comment -->
                <div class="mb-3 w-100">
                  <label for="registrar_graduation_disapproveComment" class="form-label text-muted">Comment (optional):</label>
                  <textarea class="form-control" rows="2" id="registrar_graduation_disapproveComment" placeholder="Add a comment..."></textarea>
                </div>
          
                <!-- Appointment -->
                <div id="registrar_graduation_appointmentContainer" class="mt-4">
                  <label for="registrar_graduation_appointmentDate" class="form-label text-muted">Set Appointment Date:</label>
                  <input type="date" id="registrar_graduation_appointmentDate" class="form-control mb-2">
                  <button type="button" class="btn btn-primary btn-sm w-100" id="registrar_graduation_submit_Appointment_Disapproval_Btn">Submit Disapproval and Appointment</button>
          
                  <div class="text-danger mt-2" id="registrar_graduation_disapproveError" style="display: none;">Please select a reason</div>
                  <div class="text-danger mt-1" id="registrar_graduation_appointmentError" style="display: none;">Please select an appointment date</div>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
   </form> 
  </div>

  <!-- PREVIEW & PRINT MODAL -->
  <div class="modal fade" id="previewPrintModal" tabindex="-1" aria-labelledby="previewPrintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewPrintModalLabel">
            <i class="bi bi-printer me-2"></i>Preview & Print Graduation Forms
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Loading spinner -->
          <div id="previewLoadingSpinner" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading preview...</span>
            </div>
            <span class="ms-2">Loading preview...</span>
          </div>
          
          <!-- Preview content container -->
          <div id="previewContent" class="preview-print-content" style="display: none;">
            <!-- Content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Close
          </button>
          <button type="button" class="btn btn-primary" id="printPreviewBtn">
            <i class="bi bi-printer me-1"></i>Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Graduation Form Modal - STRUCTURE COPIED FROM BUSINESS MANAGER -->
  <div class="modal fade" id="graduationFormModal" tabindex="-1" aria-labelledby="graduationFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graduationFormModalLabel">
            <i class="bi bi-file-pdf me-2"></i>Graduation Form Preview
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Loading indicator -->
          <div id="pdfPreviewLoading" class="d-flex justify-content-center align-items-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Loading form preview...</span>
          </div>
          
          <!-- PDF content container -->
          <div id="pdfPreviewContent" class="pdf-preview-content" style="display: none;">
            <!-- Content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="printGraduationBtn" style="display: none;">
            <i class="bi bi-printer me-1"></i>Print
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>
        
        <!-- CSS to isolate PDF content from affecting the main page -->
        <style>
          .pdf-modal-content body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            line-height: 1.6;
          }
          
          .pdf-modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
          }
          
          .pdf-modal-content th,
          .pdf-modal-content td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
          }
          
          .pdf-modal-content th {
            background-color: #f5f5f5;
            font-weight: bold;
          }
          
          .pdf-modal-content h1,
          .pdf-modal-content h2,
          .pdf-modal-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
          }
        </style>
      </div>
    </div>
  </div>

  <style>
    /* Scope PDF template CSS to only apply within modal */
    .pdf-modal-content {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: white;
      padding: 20px;
    }
    
    /* Hide print buttons in modal */
    .pdf-modal-content .print-button {
      display: none !important;
    }
    
    /* Ensure modal content doesn't inherit page styles */
    .pdf-modal-content * {
      box-sizing: border-box;
    }
  </style>
  
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/RGRADUATION.js' %}?v=1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  
  <script>
    // Get CSRF token from Django template 
    const CSRF_TOKEN = '{{ csrf_token }}';
    
    // Note: currentPreviewController is now managed by GraduationPrint namespace
    
    // Modal event handlers - print button handler moved to GraduationPrint namespace
    document.addEventListener('DOMContentLoaded', function() {
        // Modal close handler only - other handlers managed by GraduationPrint namespace
        const modalEl = document.getElementById('previewPrintModal');
        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', function() {
                // Reset handled by GraduationPrint namespace
            });
        }
    });

    // Print functions removed - handled by GraduationPrint namespace

    // Fallback notification function if not defined
    if (typeof showNotification !== 'function') {
        function showNotification(message, type) {
            console.log(`${type.toUpperCase()}: ${message}`);
            showAlert(message, type);
        }
    }
  </script>
{% endblock %} 


