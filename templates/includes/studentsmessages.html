<!-- Student-specific messaging layout -->
{% load static %}
<link rel="stylesheet" href="{% static 'css/student_messaging.css' %}">
<div class="student-messaging-container">
  <div class="text-end text-muted mb-2 small">
    <strong>Date:</strong> <span id="student_messages_dateToday"></span>
  </div>
  
  <h1 class="fw-bold mb-3">
    <i class="bi bi-envelope me-2"></i>
    Institutional Messages
  </h1>
  
  <!-- Messaging Interface -->
  <div class="student-enhanced-messaging-container" id="student_enhanced_messaging_container">
    <!-- Conversations Sidebar -->
    <div class="student-conversations-sidebar" id="student_conversations_sidebar">
      <div class="student-sidebar-header">
        <h5 class="student-sidebar-title">
          <i class="bi bi-chat-text me-2"></i>
          Communications
        </h5>
        
        <div class="student-search-container">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control search-input" placeholder="Search communications..." id="student_conversations_search" />
          </div>
        </div>
      </div>

      <div class="student-conversations-list" id="student_conversations_list">
        <!-- Conversations will be loaded here -->
      </div>

      <div class="student-no-conversations" id="student_no_conversations" style="display: none;">
        <div class="text-center py-5">
          <div class="no-conversations-icon">
            <i class="bi bi-chat-text"></i>
          </div>
          <h6 class="text-muted mb-2">No communications yet</h6>
          <p class="text-muted small">Your institutional communications will appear here</p>
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="student-chat-area" id="student_chat_area">
      <!-- No Chat Selected -->
      <div class="student-no-chat-selected" id="student_no_chat_selected">
        <div class="text-center py-5">
          <div class="no-chat-icon">
            <i class="bi bi-chat-square-dots"></i>
          </div>
          <h5 class="text-muted mb-3">Select a communication</h5>
          <p class="text-muted">Choose a communication from the sidebar to start messaging</p>
        </div>
      </div>

      <!-- Active Chat -->
      <div class="student-active-chat d-none" id="student_active_chat">
        <!-- Chat Header -->
        <div class="student-chat-header">
          <div class="d-flex align-items-center gap-3">
            <div class="student-chat-avatar-container">
              <img src="" class="student-chat-avatar" alt="Profile" id="student_chat_partner_avatar">
            </div>
            <div class="student-chat-partner-info">
              <div class="student-chat-partner-name" id="student_chat_partner_name">Partner Name</div>
              <div class="student-chat-partner-type" id="student_chat_partner_type">Partner Type</div>
            </div>
          </div>
          <div class="student-chat-actions">
            <button type="button" class="btn btn-sm btn-outline-primary d-md-none" onclick="toggleStudentChatBack()">
              <i class="bi bi-arrow-left"></i>
            </button>
          </div>
        </div>

        <!-- Messages Area -->
        <div class="student-messages-area" id="student_messages_area">
          <!-- Messages will be rendered here -->
        </div>

        <!-- Message Input -->
        <div class="student-message-input-area">
          <div class="student-message-input-container">
            <div class="input-actions">
              <button type="button" class="btn" onclick="toggleStudentFileInput()">
                <i class="bi bi-paperclip"></i>
              </button>
            </div>
            <textarea class="form-control message-input" placeholder="Type your message..." id="student_message_input" rows="1"></textarea>
            <button type="button" class="btn send-btn" onclick="sendStudentMessage()">
              <i class="bi bi-send text-white"></i>
            </button>
          </div>
          
          <!-- File Preview -->
          <div class="file-preview d-none" id="student_file_preview">
            <div class="file-preview-item">
              <div class="file-icon">
                <i class="bi bi-file-earmark"></i>
              </div>
              <div class="file-info">
                <div class="file-name" id="student_file_name">filename.ext</div>
                <div class="file-size" id="student_file_size">1.2 MB</div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStudentFilePreview()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
          
          <!-- Hidden file input -->
          <input type="file" id="student_file_input" style="display: none;" onchange="handleStudentFileSelect(this)">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Student-specific messaging variables
let studentCurrentConversationId = null;
let studentCurrentUser = null;
let studentConversations = [];
let studentSelectedFile = null;

// Initialize student messaging
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('student_enhanced_messaging_container')) {
    initializeStudentMessaging();
  }
});

function initializeStudentMessaging() {
  // Update current date
  const dateElement = document.getElementById('student_messages_dateToday');
  if (dateElement) {
    dateElement.textContent = new Date().toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  // Load conversations
  loadStudentConversations();
  
  // Setup message input auto-resize
  const messageInput = document.getElementById('student_message_input');
  if (messageInput) {
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendStudentMessage();
      }
    });
  }
}

function loadStudentConversations() {
  fetch('/api/conversations/')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        studentConversations = data.conversations;
        renderStudentConversations();
      }
    })
    .catch(error => {
      console.error('Error loading student conversations:', error);
    });
}

function renderStudentConversations() {
  const conversationsList = document.getElementById('student_conversations_list');
  const noConversations = document.getElementById('student_no_conversations');
  
  if (!conversationsList || !noConversations) return;
  
  if (studentConversations.length === 0) {
    noConversations.style.display = 'block';
    conversationsList.innerHTML = '';
    return;
  }
  
  noConversations.style.display = 'none';
  
  let html = '';
  studentConversations.forEach(conv => {
    const lastMessage = conv.last_message;
    const unreadBadge = conv.unread_count > 0 ? 
      `<div class="unread-badge">${conv.unread_count}</div>` : '';
    
    const messagePreview = lastMessage ? 
      (lastMessage.is_own_message ? 'You: ' : '') + 
      (lastMessage.message_type === 'file' ? 'üìé File' : 
       lastMessage.message_type === 'image' ? 'üñºÔ∏è Image' : 
       lastMessage.content) : 'No messages yet';
    
    const isActive = studentCurrentConversationId === conv.id ? 'active' : '';
    
    html += `
      <div class="conversation-item ${isActive}" onclick="openStudentConversation('${conv.id}')">
        <img src="${conv.other_user.profile_picture}" class="conversation-avatar" alt="Profile">
        <div class="conversation-info">
          <div class="conversation-name">${conv.other_user.name}</div>
          <div class="conversation-preview">${messagePreview}</div>
        </div>
        <div class="conversation-meta">
          ${unreadBadge}
          <div class="text-muted" style="font-size: 0.75rem;">
            ${formatMessageTime(lastMessage ? lastMessage.sent_at : conv.updated_at)}
          </div>
        </div>
      </div>
    `;
  });
  
  conversationsList.innerHTML = html;
}

function openStudentConversation(conversationId) {
  studentCurrentConversationId = conversationId;
  
  // Update UI
  document.getElementById('student_no_chat_selected').style.display = 'none';
  document.getElementById('student_active_chat').classList.remove('d-none');
  
  // Update active conversation in sidebar
  document.querySelectorAll('#student_conversations_list .conversation-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Find and mark active conversation
  const conversationItems = document.querySelectorAll('#student_conversations_list .conversation-item');
  conversationItems.forEach(item => {
    if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(conversationId)) {
      item.classList.add('active');
    }
  });
  
  // Load conversation messages
  loadStudentConversationMessages(conversationId);
  
  // Hide sidebar on mobile
  if (window.innerWidth <= 768) {
    document.getElementById('student_conversations_sidebar').classList.add('d-none');
  }
}

function loadStudentConversationMessages(conversationId) {
  fetch(`/api/conversations/${conversationId}/messages/`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        studentCurrentUser = data.conversation.other_user;
        
        // Update chat header
        document.getElementById('student_chat_partner_name').textContent = studentCurrentUser.name;
        document.getElementById('student_chat_partner_type').textContent = studentCurrentUser.user_type;
        document.getElementById('student_chat_partner_avatar').src = studentCurrentUser.profile_picture;
        
        // Render messages
        renderStudentMessages(data.messages);
        
        // Scroll to bottom
        scrollStudentToBottom();
        
        // Update notification badges immediately after loading messages (messages are marked as read on backend)
        if (typeof updateSidebarNotificationCount === 'function') {
          updateSidebarNotificationCount();
        }
        
        // Also reload conversations to update unread counts in sidebar
        loadStudentConversations();
      }
    })
    .catch(error => {
      console.error('Error loading student messages:', error);
    });
}

function renderStudentMessages(messages) {
  const messagesArea = document.getElementById('student_messages_area');
  if (!messagesArea) return;
  
  let html = '';
  messages.forEach(message => {
    const isOwn = message.is_own_message;
    const bubbleClass = isOwn ? 'own' : 'other';
    
    let messageContent = '';
    if (message.message_type === 'file' || message.message_type === 'image') {
      const fileIcon = message.message_type === 'image' ? 'bi-image' : 'bi-file-earmark';
      messageContent = `
        <div class="file-message">
          <div class="file-icon">
            <i class="bi ${fileIcon}"></i>
          </div>
          <div class="file-info">
            <div class="file-name">${message.file_name || 'File'}</div>
            <div class="file-size">${message.file_size_formatted || ''}</div>
          </div>
          <a href="${message.file_attachment}" download="${message.file_name}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-download"></i>
          </a>
        </div>
      `;
    } else {
      messageContent = message.content || '';
    }
    
    html += `
      <div class="message-bubble ${bubbleClass}">
        <div class="message-content">
          ${messageContent}
        </div>
        <div class="message-meta">
          ${formatMessageTime(message.sent_at)}
        </div>
      </div>
    `;
  });
  
  messagesArea.innerHTML = html;
}

function sendStudentMessage() {
  const messageInput = document.getElementById('student_message_input');
  const content = messageInput.value.trim();
  
  if (!content && !studentSelectedFile) return;
  if (!studentCurrentConversationId) return;
  
  const formData = new FormData();
  formData.append('conversation_id', studentCurrentConversationId);
  formData.append('content', content);
  
  if (studentSelectedFile) {
    formData.append('file_attachment', studentSelectedFile);
  }
  
  formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
  
  // Clear input immediately
  messageInput.value = '';
  messageInput.style.height = 'auto';
  removeStudentFilePreview();
  
  fetch('/api/send-message/', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload messages first, then conversations
      loadStudentConversationMessages(studentCurrentConversationId);
      loadStudentConversations();
    } else {
      alert('Failed to send message: ' + data.message);
      messageInput.value = content;
      if (studentSelectedFile) {
        showStudentFilePreview(studentSelectedFile);
      }
    }
  })
  .catch(error => {
    console.error('Error sending student message:', error);
    alert('Failed to send message');
    messageInput.value = content;
    if (studentSelectedFile) {
      showStudentFilePreview(studentSelectedFile);
    }
  });
}

function toggleStudentFileInput() {
  document.getElementById('student_file_input').click();
}

function handleStudentFileSelect(input) {
  const file = input.files[0];
  if (file) {
    studentSelectedFile = file;
    showStudentFilePreview(file);
  }
}

function showStudentFilePreview(file) {
  const filePreview = document.getElementById('student_file_preview');
  const fileName = document.getElementById('student_file_name');
  const fileSize = document.getElementById('student_file_size');
  
  if (filePreview && fileName && fileSize) {
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    filePreview.classList.remove('d-none');
  }
}

function removeStudentFilePreview() {
  const filePreview = document.getElementById('student_file_preview');
  const fileInput = document.getElementById('student_file_input');
  
  if (filePreview) filePreview.classList.add('d-none');
  if (fileInput) fileInput.value = '';
  studentSelectedFile = null;
}

function toggleStudentChatBack() {
  document.getElementById('student_conversations_sidebar').classList.remove('d-none');
  document.getElementById('student_active_chat').classList.add('d-none');
  document.getElementById('student_no_chat_selected').style.display = 'block';
}

function scrollStudentToBottom() {
  const messagesArea = document.getElementById('student_messages_area');
  if (messagesArea) {
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatMessageTime(timeStr) {
  const date = new Date(timeStr);
  const now = new Date();
  const diffInMs = now - date;
  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
  
  if (diffInDays === 0) {
    return date.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  } else if (diffInDays === 1) {
    return 'Yesterday';
  } else if (diffInDays < 7) {
    return date.toLocaleDateString('en-US', { weekday: 'short' });
  } else {
    return date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric' 
    });
  }
}

// Helper function to get CSRF token (reuse existing function)
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>