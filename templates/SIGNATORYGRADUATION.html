{% extends 'main-signatory.html' %}
{% load static %}

{% block title %}SIGNATORY GRADUATION{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/SGRADUATION.css' %}">
{% endblock %}

{% block main_content %}
  <div class="signatory_graduation_main-content">
    <form id="signatory_graduation_form">
      <div class="text-end text-muted mb-2 small"><strong>Date:</strong> <span id="signatory_graduation_dateToday"></span></div>
      <h1 class="fw-bold">List of Graduation Forms</h1>

      <!-- Filter + Search Row -->
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
          <select class="form-select form-select-sm" style="width: auto;" id="signatory_graduation_filter_course">
            <option value="" selected disabled>Filter by Course</option>
          </select>
          <select class="form-select form-select-sm" style="width: auto;" id="signatory_graduation_filter_year">
            <option value="" selected disabled>Filter by Year</option>
          </select>
          <select class="form-select form-select-sm" style="width: auto;" id="signatory_graduation_filter_section">
            <option value="" selected disabled>Filter by Section</option>
          </select>
          <select class="form-select form-select-sm" style="width: auto;" id="signatory_graduation_filter_status">
            <option value="" selected disabled>Filter by Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="disapproved">Disapproved</option>
          </select>
    
          <!-- Search input right next to filters -->
          <div class="signatory_graduation_search-bar input-group">
            <input type="text" class="form-control" placeholder="Search" id="signatory_graduation_search_input">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
          
          <!-- Reset Filter Button -->
          <button type="button" class="btn btn-outline-secondary btn-sm" id="signatory_graduation_reset_filter">
            <i class="bi bi-arrow-clockwise"></i> Reset
          </button>
      </div>

      <!-- Bulk Actions -->
      <div class="row mb-3" id="signatory_graduation_bulk_actions" style="display: none;">
        <div class="col-12">
          <div class="d-flex gap-2 align-items-center">
            <span class="text-muted small" id="signatory_graduation_selected_count">0 selected</span>
            <button type="button" class="btn btn-success btn-sm" id="signatory_graduation_bulk_print">
              <i class="bi bi-printer me-1"></i>Bulk Print
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="signatory_graduation_bulk_approve">
              <i class="bi bi-check-circle me-1"></i>Bulk Approve
            </button>
            <button type="button" class="btn btn-warning btn-sm" id="signatory_graduation_bulk_disapprove">
              <i class="bi bi-x-circle me-1"></i>Bulk Disapprove
            </button>
          </div>
        </div>
      </div>

      <div class="signatory_graduation_table-fixed-container">
        <div class="signatory_graduation_table-scroll-wrapper">
          <table class="table signatory_graduation_table text-center align-middle">
              <thead class="table-dark">
                  <tr>
                  <th style="width: 60px;">
                    <input type="checkbox" id="signatory_graduation_select_all">
                  </th>
                  <th style="width: 250px;">Student's Name</th>
                  <th style="width: 150px;">Course</th>
                  <th style="width: 90px;">Year</th>
                  <th style="width: 100px;">Section</th>
                  <th style="width: 140px;">ID Number</th>
                  <th style="width: 130px;">Application No.</th>
                  <th style="width: 150px;">Date Submitted</th>
                  <th style="width: 200px;">PDF File</th>
                  <th style="width: 160px;">Academic Dean</th>
                  <th style="width: 160px;">Business Manager</th>
                  <th style="width: 160px;">Registrar</th>
                  <th style="width: 160px;">President</th>
                  <th style="width: 150px;">Status</th>
                  <th style="width: 100px;">Actions</th>
                  </tr>
              </thead>
              <tbody id="signatory_graduation_table_body">
                  <!-- Data will be loaded dynamically -->
              </tbody>
          </table>
          
          <!-- OTP SIDEBAR -->
          <div id="signatory_graduation_otpSidebar" class="signatory_graduation_otp-sidebar">
            <div class="signatory_graduation_otp-header d-flex justify-content-between align-items-start">
              <h4 class="mb-0 fw-bold" id="signatory_graduation_approve_title">APPROVAL PIN</h4>
              <button type="button" class="btn-close" onclick="closeOtpSidebar()" aria-label="Close"></button>
            </div>
            <div class="signatory_graduation_otp-body d-flex flex-column align-items-center justify-content-center text-center">
              <p class="text-muted mb-3 w-100 text-start">Input Pincode to Proceed:</p>
              <div class="d-flex justify-content-center gap-2 mb-3">
                <input type="text" class="form-control text-center" maxlength="8" placeholder="Enter PIN" id="signatory_graduation_otpinput">
              </div>
              <div class="mb-3 w-100">
                <label for="signatory_graduation_otpComment" class="form-label text-muted">Comment (optional):</label>
                <textarea class="form-control" rows="2" id="signatory_graduation_otpComment" placeholder="Add a comment..."></textarea>
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-dark signatory_graduation_approve-btn" id="signatory_graduation_verifyOtpBtn">APPROVE</button>
              </div>
              <div class="text-danger mt-2" id="signatory_graduation_otpError" style="display: none;">Incorrect PIN</div>
            </div>
          </div>

          <!-- DISAPPROVE SIDEBAR -->
          <div id="signatory_graduation_disapproveSidebar" class="signatory_graduation_otp-sidebar">
            <div class="signatory_graduation_otp-header d-flex justify-content-between align-items-start">
              <h4 class="mb-0 fw-bold" id="signatory_graduation_disapprove_title">DISAPPROVE REASON</h4>
              <button type="button" class="btn-close" onclick="closeDisapproveSidebar()" aria-label="Close"></button>
            </div>
          
            <!-- WRAPPER for body steps -->
            <div class="signatory_graduation_otp-body">
          
              <!-- STEP 1: PIN -->
              <div id="signatory_graduation_disapprove_pin_step">
                <p class="text-muted mb-3 w-100 text-start">Input Pincode to Proceed:</p>
                <div class="d-flex justify-content-center gap-2 mb-3">
                  <input type="text" class="form-control text-center" maxlength="8" placeholder="Enter PIN" id="signatory_graduation_disapprove_pin_input">
                </div>
                <div class="text-center mb-2">
                  <button type="button" class="btn btn-dark" id="signatory_graduation_disapprove_pin_submit_btn">VERIFY</button>
                </div>
                <div class="text-danger mt-2" id="signatory_graduation_disapprove_pin_error" style="display: none;">Incorrect PIN</div>
              </div>
          
              <!-- STEP 2: Reason (Initially hidden) -->
              <div id="signatory_graduation_disapprove_reason_step" style="display: none;">
                <p class="text-muted mb-3 w-100 text-start">Please select a reason:</p>
          
                <!-- REASONS -->
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Unpaid fees" id="signatory_graduation_reason1">
                  <label class="form-check-label" for="signatory_graduation_reason1">Unpaid fees</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Damage to school property" id="signatory_graduation_reason2">
                  <label class="form-check-label" for="signatory_graduation_reason2">Damage to school property</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Violation of rules" id="signatory_graduation_reason3">
                  <label class="form-check-label" for="signatory_graduation_reason3">Violation of rules</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Unreturned school property" id="signatory_graduation_reason4">
                  <label class="form-check-label" for="signatory_graduation_reason4">Unreturned school property</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Incomplete Requirements/Documents" id="signatory_graduation_reason5">
                  <label class="form-check-label" for="signatory_graduation_reason5">Incomplete Requirements/Documents</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Incomplete course requirements" id="signatory_graduation_reason6">
                  <label class="form-check-label" for="signatory_graduation_reason6">Incomplete course requirements</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Unsettled promissory note" id="signatory_graduation_reason7">
                  <label class="form-check-label" for="signatory_graduation_reason7">Unsettled promissory note</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Incomplete academic units" id="signatory_graduation_reason8">
                  <label class="form-check-label" for="signatory_graduation_reason8">Incomplete academic units</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" value="Other" id="signatory_graduation_reasonOther" onchange="toggleOtherReasonInput()">
                  <label class="form-check-label" for="signatory_graduation_reasonOther">Other</label>
                </div>
          
                <!-- "Other" input field (Initially hidden) -->
                <div id="signatory_graduation_otherReasonContainer" style="display: none;" class="mb-2">
                  <input type="text" class="form-control" placeholder="Enter other reason" id="signatory_graduation_otherReasonInput">
                </div>
          
                <!-- Comment (optional) -->
                <div class="mb-3 w-100">
                  <label for="signatory_graduation_disapproveComment" class="form-label text-muted">Comment (optional):</label>
                  <textarea class="form-control" rows="2" id="signatory_graduation_disapproveComment" placeholder="Add a comment..."></textarea>
                </div>
          
                <!-- Appointment -->
                <div id="signatory_graduation_appointmentContainer" class="mt-4">
                  <label for="signatory_graduation_appointmentDate" class="form-label text-muted">Set Appointment Date:</label>
                  <input type="date" id="signatory_graduation_appointmentDate" class="form-control mb-2">

                  <div class="text-center mt-3">
                    <button type="button" class="btn btn-danger w-100" id="signatory_graduation_submit_Appointment_Disapproval_Btn">SUBMIT DISAPPROVAL</button>
                  </div>

                  <div class="text-danger mt-2" id="signatory_graduation_disapproveError" style="display: none;">Please select a reason</div>
                  <div class="text-danger mt-1" id="signatory_graduation_appointmentError" style="display: none;">Please select an appointment date</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- PREVIEW & PRINT MODAL -->
  <div class="modal fade" id="previewPrintModal" tabindex="-1" aria-labelledby="previewPrintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewPrintModalLabel">
            <i class="bi bi-printer me-2"></i>Preview & Print Graduation Forms
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Loading spinner -->
          <div id="previewLoadingSpinner" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading preview...</span>
            </div>
            <span class="ms-2">Loading preview...</span>
          </div>
          
          <!-- Preview content container -->
          <div id="previewContent" class="preview-print-content" style="display: none;">
            <!-- Content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Close
          </button>
          <button type="button" class="btn btn-primary" id="printPreviewBtn">
            <i class="bi bi-printer me-1"></i>Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Graduation Form Modal - EXACT COPY FROM REGISTRAR -->
  <div class="modal fade" id="graduationFormModal" tabindex="-1" aria-labelledby="graduationFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graduationFormModalLabel">
            <i class="bi bi-file-pdf me-2"></i>Graduation Form Preview
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Loading indicator -->
          <div id="pdfPreviewLoading" class="d-flex justify-content-center align-items-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Loading form preview...</span>
          </div>
          
          <!-- PDF content container -->
          <div id="pdfPreviewContent" class="pdf-preview-content" style="display: none;">
            <!-- Content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="printGraduationBtn" style="display: none;">
            <i class="bi bi-printer me-1"></i>Print
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CSS for preview and print modals -->
  <style>
    /* Preview & Print Modal Styles */
    .preview-print-content {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: white;
      padding: 20px;
      overflow-y: auto;
      max-height: 70vh;
    }
  </style>

  <!-- CSS to isolate PDF content from affecting the main page -->
  <style>
    .pdf-modal-content body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      line-height: 1.6;
    }
    
    .pdf-modal-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .pdf-modal-content th,
    .pdf-modal-content td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    
    .pdf-modal-content th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    
    .pdf-modal-content h1,
    .pdf-modal-content h2,
    .pdf-modal-content h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    
    /* Scope PDF template CSS to only apply within modal */
    .pdf-modal-content {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: white;
      padding: 20px;
    }
    
    /* Hide print buttons in modal */
    .pdf-modal-content .print-button {
      display: none !important;
    }
    
    /* Ensure modal content doesn't inherit page styles */
    .pdf-modal-content * {
      box-sizing: border-box;
    }
  </style>

  {% csrf_token %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/SGRADUATION.js' %}"></script>
{% endblock %}