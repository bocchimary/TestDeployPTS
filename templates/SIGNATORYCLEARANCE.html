{% extends 'main-signatory.html' %}
{% load static %}

{% block title %}SIGNATORY CLEARANCE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/SCLEARANCE.css' %}">
<style>
/* Hide the modal - keep it functional but invisible */
#previewPrintModal {
  display: none !important;
}
/* Preview & Print Modal Styles - MATCHES BUSINESS MANAGER */
.preview-print-content {
  font-family: Arial, sans-serif;
  line-height: 1.6;
  background: white;
  padding: 20px;
}

.clearance-form {
  margin-bottom: 30px;
}

.copy-container {
  position: relative;
  border: 1px solid #333;
  padding: 20px;
  margin-bottom: 20px;
  background: white;
}

.watermark {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 10px;
  color: #666;
  font-weight: bold;
}

.title {
  text-align: center;
  font-weight: bold;
  font-size: 18px;
  margin: 0;
  padding: 0;
}

.subtitle {
  margin: 0;
  text-align: center;
  font-size: 12px;
}

.clearance {
  margin: 0;
  text-align: center;
  font-weight: bold;
  font-size: 12px;
}

.year {
  margin: 0;
  text-align: center;
  font-size: 12px;
}

.row-container {
  display: flex;
  justify-content: space-between;
  margin: 10px 0;
}

.name, .course {
  font-weight: bold;
  text-align: left;
  font-size: 10px;
}

.row-line, .row-line-1 {
  text-decoration: underline;
  margin: 0 5px;
}

.desc {
  font-size: 10px;
  display: block;
  margin: 10px 0;
}

.dept-table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
  font-size: 9px;
}

.dept-table th, .dept-table td {
  border: 1px solid #333;
  padding: 5px;
  text-align: left;
}

.dept-text {
  width: 60%;
  font-weight: bold;
  text-align: center;
}

.dept-sign {
  width: 40%;
  font-weight: bold;
  text-align: center;
}

.approved-signature {
  color: green;
  font-weight: bold;
  font-size: 9px;
}

.disapproved-signature {
  color: red;
  font-weight: bold;
  font-size: 9px;
}

.pending-signature {
  color: orange;
  font-weight: bold;
  font-size: 9px;
}

.signatory-reminder, .purpose {
  font-size: 8px;
  text-align: center;
  margin: 5px 0;
}

.page-break {
  page-break-before: always;
  border-top: 2px dashed #ccc;
  margin: 20px 0;
  text-align: center;
  color: #666;
  font-size: 12px;
}

.page-break::before {
  content: "Page Break";
  background: white;
  padding: 0 10px;
}

/* Modal preview styles only - printing handled by iframe */
</style>
{% endblock %}

{% block main_content %}
  <div class="signatory_clearance_main-content">
    <form id="signatory_clearance_form">
      {% csrf_token %}
      <div class="text-end text-muted mb-2 small"><strong>Date:</strong> <span id="signatory_clearance_dateToday"></span></div>
      <h1 class="fw-bold">List of Clearance</h1>

      <!-- Filter + Search Row -->
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <select class="form-select form-select-sm" style="width: auto;" id="signatory_clearance_filter_course">
          <option selected disabled>Filter by Course</option>
        </select>
        <select class="form-select form-select-sm" style="width: auto;" id="signatory_clearance_filter_year">
          <option selected disabled>Filter by Year</option>
        </select>
        <select class="form-select form-select-sm" style="width: auto;" id="signatory_clearance_filter_section">
          <option selected disabled>Filter by Section</option>
        </select>
        <select class="form-select form-select-sm" style="width: auto;" id="signatory_clearance_filter_status">
          <option selected disabled>Filter by Status</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
        </select>
        <div class="signatory_clearance_search-bar input-group">
          <input type="text" class="form-control" placeholder="Search" id="signatory_clearance_search_input">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
        </div>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="signatory_clearance_reset_filters">
          <i class="bi bi-arrow-clockwise"></i> Reset Filters
        </button>
      </div>

      <!-- Bulk Actions -->
      <div class="d-flex gap-2 align-items-center mb-3" id="signatory_clearance_bulk_actions" style="display: none;">
        <span class="text-muted small" id="signatory_clearance_selected_count">0 selected</span>
        <button type="button" class="btn btn-primary btn-sm" id="signatory_clearance_bulk_approve">
          <i class="bi bi-check-circle me-1"></i>Bulk Approve
        </button>
        <button type="button" class="btn btn-danger btn-sm" id="signatory_clearance_bulk_disapprove">
          <i class="bi bi-x-circle me-1"></i>Bulk Disapprove
        </button>
        <button type="button" class="btn btn-success btn-sm" id="signatory_clearance_bulk_print">
          <i class="bi bi-printer me-1"></i>Bulk Print
        </button>
      </div>

      <!-- Table -->
      <div class="signatory_clearance_table-fixed-container">
        <div class="signatory_clearance_table-scroll-wrapper">
          <table class="table signatory_clearance_table text-center align-middle">
            <thead class="table-dark">
              <tr>
                <th style="width: 60px;">
                  <input type="checkbox" id="signatory_clearance_select_all">
                </th>
                <th style="width: 250px;">Student's Name</th>
                <th style="width: 150px;">Course</th>
                <th style="width: 90px;">Year</th>
                <th style="width: 100px;">Section</th>
                <th style="width: 150px;">ID Number</th>
                <th style="width: 150px;">Date Submitted</th>
                <th style="width: 160px;" id="current_signatory_header">My Approval</th>
                <th style="width: 200px;">Overall Summary</th>
                <th style="width: 150px;">Status</th>
                <th style="width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody id="signatory_clearance_table_body">
              <!-- Data will be loaded dynamically -->
            </tbody>
          </table>
        </div>

        <!-- OTP Sidebar -->
        <div id="signatory_clearance_otpSidebar" class="signatory_clearance_otp-sidebar">
          <div class="signatory_clearance_otp-header d-flex justify-content-between align-items-start">
            <h4 class="mb-0 fw-bold">APPROVAL PIN</h4>
            <button type="button" class="btn-close" onclick="closeOtpSidebar()" aria-label="Close"></button>
          </div>
          <div class="signatory_clearance_otp-body d-flex flex-column align-items-center justify-content-center text-center">
            <p class="text-muted mb-3 w-100 text-start">Input Pincode to Proceed:</p>
            <div class="d-flex justify-content-center gap-2 mb-3">
              <input type="password" class="form-control text-center" maxlength="8" placeholder="Enter PIN" id="signatory_clearance_otpinput">
            </div>
            <div class="mb-3 w-100">
              <label for="signatory_clearance_otpComment" class="form-label text-muted">Comment (optional):</label>
              <textarea class="form-control" rows="2" id="signatory_clearance_otpComment" placeholder="Add a comment..."></textarea>
            </div>
            <div class="text-center">
              <button type="button" class="btn btn-dark signatory_clearance_approve-btn" id="signatory_clearance_verifyOtpBtn">APPROVE</button>
            </div>
            <div class="text-danger mt-2" id="signatory_clearance_otpError" style="display: none;">Incorrect PIN</div>
          </div>
        </div>

        <!-- Disapprove Sidebar -->
        <div id="signatory_clearance_disapproveSidebar" class="signatory_clearance_otp-sidebar">
          <div class="signatory_clearance_otp-header d-flex justify-content-between align-items-start">
            <h4 class="mb-0 fw-bold">DISAPPROVE REASON</h4>
            <button type="button" class="btn-close" onclick="closeDisapproveSidebar()" aria-label="Close"></button>
          </div>

          <!-- WRAPPER for body steps -->
          <div class="signatory_clearance_otp-body">

            <!-- STEP 1: PIN -->
            <div id="signatory_clearance_disapprove_pin_step">
              <p class="text-muted mb-3 w-100 text-start">Input Pincode to Proceed:</p>
              <div class="d-flex justify-content-center gap-2 mb-3">
                <input type="password" class="form-control text-center" maxlength="8" placeholder="Enter PIN" id="signatory_clearance_disapprove_pin_input">
              </div>
              <div class="text-center mb-2">
                <button type="button" class="btn btn-dark" id="signatory_clearance_disapprove_pin_submit_btn">VERIFY</button>
              </div>
              <div class="text-danger mt-2" id="signatory_clearance_disapprove_pin_error" style="display: none;">Incorrect PIN</div>
            </div>

            <!-- STEP 2: Reason (Initially hidden) -->
            <div id="signatory_clearance_disapprove_reason_step" style="display: none;">
              <p class="text-muted mb-3 w-100 text-start">Please select a reason:</p>

              <!-- REASONS -->
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Unpaid fees" id="signatory_clearance_reason1">
                <label class="form-check-label" for="signatory_clearance_reason1">Unpaid fees</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Damage to school property" id="signatory_clearance_reason2">
                <label class="form-check-label" for="signatory_clearance_reason2">Damage to school property</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Violation of rules" id="signatory_clearance_reason3">
                <label class="form-check-label" for="signatory_clearance_reason3">Violation of rules</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Unreturned school property" id="signatory_clearance_reason4">
                <label class="form-check-label" for="signatory_clearance_reason4">Unreturned school property</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Incomplete Requirements/Documents" id="signatory_clearance_reason5">
                <label class="form-check-label" for="signatory_clearance_reason5">Incomplete Requirements/Documents</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Incomplete course requirements" id="signatory_clearance_reason6">
                <label class="form-check-label" for="signatory_clearance_reason6">Incomplete course requirements</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Unsettled promissory note" id="signatory_clearance_reason7">
                <label class="form-check-label" for="signatory_clearance_reason7">Unsettled promissory note</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Incomplete academic units" id="signatory_clearance_reason8">
                <label class="form-check-label" for="signatory_clearance_reason8">Incomplete academic units</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="Other" id="signatory_clearance_reasonOther" onchange="toggleOtherReasonInput()">
                <label class="form-check-label" for="signatory_clearance_reasonOther">Other</label>
              </div>

              <div class="mb-2" id="signatory_clearance_otherReasonContainer" style="display: none;">
                <input type="text" id="signatory_clearance_otherReasonInput" class="form-control" placeholder="Enter other reason">
              </div>

              <!-- Comment -->
              <div class="mb-3 w-100">
                <label for="signatory_clearance_disapproveComment" class="form-label text-muted">Comment (optional):</label>
                <textarea class="form-control" rows="2" id="signatory_clearance_disapproveComment" placeholder="Add a comment..."></textarea>
              </div>

              <!-- Appointment -->
              <div id="signatory_clearance_appointmentContainer" class="mt-4">
                <label for="signatory_clearance_appointmentDate" class="form-label text-muted">Set Appointment Date:</label>
                <input type="date" id="signatory_clearance_appointmentDate" class="form-control mb-2">
                <button type="button" class="btn btn-primary btn-sm w-100" id="signatory_clearance_submit_Appointment_Disapproval_Btn">Submit Disapproval and Appointment</button>

                <div class="text-danger mt-2" id="signatory_clearance_disapproveError" style="display: none;">Please select a reason</div>
                <div class="text-danger mt-1" id="signatory_clearance_appointmentError" style="display: none;">Please select an appointment date</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>  
  </div>

  <!-- PREVIEW & PRINT MODAL - COPIED FROM BUSINESS MANAGER -->
  <div class="modal fade" id="previewPrintModal" tabindex="-1" aria-labelledby="previewPrintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewPrintModalLabel">
            <i class="bi bi-printer me-2"></i>Preview & Print Clearance Forms
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Loading spinner -->
          <div id="previewLoadingSpinner" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading preview...</span>
            </div>
            <span class="ms-2">Loading preview...</span>
          </div>
          
          <!-- Preview content container -->
          <div id="previewContent" class="preview-print-content" style="display: none;">
            <!-- Content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Close
          </button>
          <button type="button" class="btn btn-primary" id="printPreviewBtn">
            <i class="bi bi-printer me-1"></i>Print
          </button>
        </div>
      </div>
    </div>
  </div>


{% endblock %}

{% block extra_js %}
<script src="{% static 'js/SCLEARANCE.js' %}"></script>
{% endblock %}
